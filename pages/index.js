import Head from 'next/head';
import BaseLayout from '../components/container/BaseLayout'
import firebaseApp from '../net/firebaseApp';
import {Table} from 'antd'
import { Select } from 'antd';
import { getFirestore , doc , updateDoc , orderBy,  collection , onSnapshot , query } from "firebase/firestore";
import { Fragment, useEffect, useState } from 'react';
import { DateTime } from 'luxon';

const { Option } = Select;
const formatter = Intl.NumberFormat('ko-kr')
const store = getFirestore(firebaseApp);
const orders = collection(store , 'orders');

const q = query(orders , orderBy( 'createdAt' , 'desc'));


export default function Home() {
  const [list , setList] = useState([]);

  useEffect(() => {
       return onSnapshot( q , docs => {
         const newList = [];
        docs.forEach(doc => newList.push(({id : doc.id , ...doc.data()})))
         setList(newList)
       })
  }, [])

  function sum(array){
    return array.reduce((acc, num) => {
     acc += num
     return acc
   }, 0)
 }


  const columns = [
    {
      title: '이름',
      dataIndex: 'name',
      key: 'name',
    },
    {
      title: '커피주문내역',
      dataIndex: 'items',
      key: 'items',
      render : (text, record) => {
        return <div> 
            <ul>
                {record.items.map(item => (
                  <Fragment key={item.name}>
                        <li>{item.name} {formatter.format(item.price)}원 &times; {item.count}</li>  
                  </Fragment>
                ))}
            </ul>
          
        </div>
      }
    },
    {
      title: '커피 합계 금액',
      dataIndex: 'itams',
      key: 'total',
      render : (text , record) => {
        return (
            <div>
            합계 : {formatter.format(sum(record.items.map(item => item.count * item.price)))}원
           </div>
        )
      }
    },
    {
      title: '음료주문이름',
      dataIndex: 'drinkings',
      key: 'drinkings',
      render : (text , record) => {
        if(record.drinkings){
          return <div>
          <ul>
              {record.drinkings.map(item => (
                <Fragment key={item.name}>
                    <li>{item.name} {formatter.format(item.price)}원 &times; {item.count}</li>
                </Fragment>
              ))}
          </ul>
        </div>  
        }else{
         return <div>
                  음료주문 없음
                </div>
        }
      }
    },
    {
      title: '음료 합계 금액',
      dataIndex: 'drinkings',
      key: 'total',
      render : (text , record) => {
        if(record.drinkings){
          return (
            <div>
            합계 : {formatter.format(sum(record.drinkings.map(item => item.count * item.price)))}원
           </div>
        )
        }
      }
    },
    {
      title: '총 합계',
      dataIndex: 'total',
      key: 'total',
      render : (text , record) => {
        if(record.drinkings){
          return (
            <div>
            합계 : {formatter.format(sum(record.drinkings.map(item => item.count * item.price)) + sum(record.items.map(item => item.count * item.price)))}원
           </div>
        )
        }else{
          return (
            <div>
            합계 : {formatter.format(sum(record.items.map(item => item.count * item.price)))}원
           </div>
        )
        }
      }
    },
    {
      title: '결제',
      dataIndex: 'paymentResult',
      key: 'paymentResult',
      render : (text , record) => {
        return (
            record.paymentResult ? "카드결제" : "현장 결제"
        )
      }
    },
    {
      title: '상태',
      dataIndex: 'status',
      key: 'status',
      render : (text , record) => {
        return <Select value={text} onChange={value => {
          updateDoc(doc(store , 'orders' , record.id), {status : value});

        }}>
            <Select.Option value="주문완료">주문완료</Select.Option>
            <Select.Option value="제조중">제조중</Select.Option>
            <Select.Option value="제조 완료">제조 완료</Select.Option>
            <Select.Option value="픽업 완료">픽업 완료</Select.Option>
          </Select>
      }
    },
    {
      title: '주문시각',
      dataIndex: 'createdAt',
      key: 'createdAt',
      render : (text , record) => {
        return DateTime.fromSeconds(record.createdAt.seconds).toFormat('LL-dd HH:mm')
      }
    },
  ];

  


  return (
      <BaseLayout>
           <Head>
            <title>Create Next App</title>
            <meta name="description" content="Generated by create next app" />
            <link rel="icon" href="/favicon.ico" />
          </Head>
          <h1>주문 확인</h1>
          {console.log('list' , list)}
          <Table dataSource={list} columns={columns} rowKey={'id'} />
 
      </BaseLayout> 
  )
}
